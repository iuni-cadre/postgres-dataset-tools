-- This SQL script loads OpenAlex data from backwards
-- compatible MAG formatted data in CSV files.  The
-- CSV files are assumed to have been generated by the
-- 

\COPY oamag_core.affiliations FROM '/N/project/mag/FilteredMagData/openalex_mag_2022/oa_affiliations.csv' DELIMITER '~' ENCODING 'UTF-8' CSV HEADER; 

--Use this query to copy from staging table into final table to remove
--duplicates.
--INSERT INTO oamag_core.authors
--SELECT *
--FROM oamag_core.authors_staging
--ON CONFLICT (author_id) DO NOTHING;
--
--Read into a staging table and perform the above
\COPY oamag_core.authors_staging FROM '/N/project/mag/FilteredMagData/openalex_mag_2022/split_authors/oa_authors_00' DELIMITER '~' ENCODING 'UTF-8' CSV HEADER;
--\COPY oamag_core.authors_staging FROM '/N/project/mag/FilteredMagData/openalex_mag_2022/split_authors/oa_authors_07' DELIMITER '~' ENCODING 'UTF-8' CSV;

\COPY oamag_core.journals FROM '/N/project/mag/FilteredMagData/openalex_mag_2022/oa_journals.csv' DELIMITER '~' ENCODING 'UTF-8' CSV HEADER;

\COPY oamag_core.conference_series FROM '/N/project/mag/FilteredMagData/openalex_mag_2022/oa_conferenceSeries.csv' DELIMITER '~' ENCODING 'UTF-8' CSV HEADER;

\COPY oamag_core.fields_of_study FROM '/N/project/mag/FilteredMagData/openalex_mag_2022/oa_fieldsOfStudy.csv' DELIMITER '~' ENCODING 'UTF-8' CSV HEADER;

\COPY oamag_core.conference_instances FROM '/N/project/mag/FilteredMagData/openalex_mag_2022/oa_conferenceInstances.csv' DELIMITER '~' ENCODING 'UTF-8' CSV HEADER;

--Use this query to copy from staging table into final table to remove
--duplicates.
\COPY oamag_core.papers_staging FROM '/N/project/mag/FilteredMagData/openalex_mag_2022/oa_papers.csv' DELIMITER '~' ENCODING 'UTF-8' CSV HEADER;
--Use this query to copy from staging table into final table to remove
--duplicates.
--INSERT INTO oamag_core.papers
--SELECT *
--FROM oamag_core.papers_staging
--ON CONFLICT (paper_id) DO NOTHING;
--

\COPY oamag_core.paper_resources FROM '/N/project/mag/FilteredMagData/openalex_mag_2022/oa_paperResources.csv' DELIMITER '~' ENCODING 'UTF-8' CSV HEADER;

\COPY oamag_core.related_field_of_study FROM '/N/project/mag/FilteredMagData/openalex_mag_2022/oa_relatedFieldOfStudy.csv' DELIMITER '~' ENCODING 'UTF-8' CSV HEADER;

--Use this query to copy from staging table into final table to remove
--duplicates.
\COPY oamag_core.paper_urls_staging FROM '/N/project/mag/FilteredMagData/openalex_mag_2022/oa_paperURLs.csv' DELIMITER '~' ENCODING 'UTF-8' CSV HEADER;
--
--INSERT INTO oamag_core.paper_urls
--SELECT * FROM oamag_core.paper_urls_staging AS f
--WHERE f.paper_id IN (SELECT paper_id FROM oamag_core.papers);

\COPY oamag_core.paper_abstract_inverted_index FROM '/N/project/mag/FilteredMagData/openalex_mag_2022/oa_paperAbstractInvertedIndex.csv' DELIMITER '~' ENCODING 'UTF-8' CSV HEADER;

\COPY oamag_core.paper_author_affiliations FROM '/N/project/mag/FilteredMagData/openalex_mag_2022/oa_paperAuthorAffiliations.csv' DELIMITER '~' ENCODING 'UTF-8' CSV HEADER;

/* The paper citation contexts table has a problem with special characters or control characters. You may want to skip this table but you can try and see if it works for you */

\COPY oamag_core.paper_citation_contexts FROM '/N/project/mag/FilteredMagData/openalex_mag_2022/oa_paperCitationContexts.csv' DELIMITER '~' ENCODING 'UTF-8' CSV HEADER;

\COPY oamag_core.paper_fields_of_study FROM '/N/project/mag/FilteredMagData/openalex_mag_2022/oa_paperFieldsOfStudy.csv' DELIMITER '~' ENCODING 'UTF-8' CSV HEADER;

\COPY oamag_core.paper_recommendations FROM '/N/project/mag/FilteredMagData/openalex_mag_2022/oa_paperRecommendations.csv' DELIMITER '~' ENCODING 'UTF-8' CSV HEADER;

\COPY oamag_core.paper_references FROM '/N/project/mag/FilteredMagData/openalex_mag_2022/oa_paperReferences.csv' DELIMITER '~' ENCODING 'UTF-8' CSV HEADER;

\COPY oamag_core.field_of_study_children FROM '/N/project/mag/FilteredMagData/openalex_mag_2022/oa_fieldOfStudyChildren.csv' DELIMITER '~' ENCODING 'UTF-8' CSV HEADER;


/*
\COPY paper_citation_contexts FROM '/raw/mag-clean/PaperCitationContexts.txt' DELIMITER E'\t' ENCODING 'UTF-8' CSV HEADER;

*/
